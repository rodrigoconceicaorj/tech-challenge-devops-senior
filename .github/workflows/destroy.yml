name: Destroy Infra

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: tech-challenge-eks
  EKS_NODEGROUP_NAME: tech-challenge-ng
  RDS_IDENTIFIER: tech-challenge-comments-db
  ECR_REPOSITORY: tech-challenge-api

jobs:
  destroy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Try delete Kubernetes resources
        continue-on-error: true
        run: |
          aws eks update-kubeconfig --name "${{ env.EKS_CLUSTER_NAME }}" --region "${{ env.AWS_REGION }}" || true
          kubectl delete -f k8s/manifests --ignore-not-found=true || true
          kubectl delete secret db-secret --ignore-not-found=true || true

      - name: Terraform destroy (if state available)
        continue-on-error: true
        run: |
          cd infra/terraform
          terraform init -input=false
          terraform destroy -auto-approve -input=false

      - name: Fallback AWS CLI teardown
        shell: bash
        run: |
          set -e
          set -o pipefail

          CLUSTER="${{ env.EKS_CLUSTER_NAME }}"
          NODEGROUP="${{ env.EKS_NODEGROUP_NAME }}"
          RDS_ID="${{ env.RDS_IDENTIFIER }}"
          REGION="${{ env.AWS_REGION }}"
          REPO="${{ env.ECR_REPOSITORY }}"

          aws eks delete-nodegroup --cluster-name "$CLUSTER" --nodegroup-name "$NODEGROUP" || true
          aws eks delete-cluster --name "$CLUSTER" || true
          aws rds delete-db-instance --db-instance-identifier "$RDS_ID" --skip-final-snapshot || true
          aws ecr delete-repository --repository-name "$REPO" --force || true

          VPC_ID=$(aws ec2 describe-vpcs --filters "Name=tag:Name,Values=tech-challenge-vpc" --query "Vpcs[0].VpcId" --output text)
          if [ "$VPC_ID" != "None" ] && [ -n "$VPC_ID" ]; then
            IGW_ID=$(aws ec2 describe-internet-gateways --filters "Name=attachment.vpc-id,Values=$VPC_ID" --query "InternetGateways[0].InternetGatewayId" --output text)
            if [ "$IGW_ID" != "None" ] && [ -n "$IGW_ID" ]; then
              aws ec2 detach-internet-gateway --internet-gateway-id "$IGW_ID" --vpc-id "$VPC_ID" || true
              aws ec2 delete-internet-gateway --internet-gateway-id "$IGW_ID" || true
            fi

            NAT_ID=$(aws ec2 describe-nat-gateways --filter Name=vpc-id,Values=$VPC_ID --query "NatGateways[0].NatGatewayId" --output text)
            if [ "$NAT_ID" != "None" ] && [ -n "$NAT_ID" ]; then
              aws ec2 delete-nat-gateway --nat-gateway-id "$NAT_ID" || true
            fi

            ALLOC_ID=$(aws ec2 describe-addresses --filters "Name=tag:Name,Values=tech-challenge-nat-eip" --query "Addresses[0].AllocationId" --output text)
            if [ "$ALLOC_ID" != "None" ] && [ -n "$ALLOC_ID" ]; then
              aws ec2 release-address --allocation-id "$ALLOC_ID" || true
            fi

            # Delete route table associations
            RT_IDS=$(aws ec2 describe-route-tables --filters "Name=vpc-id,Values=$VPC_ID" --query "RouteTables[].RouteTableId" --output text)
            for RT in $RT_IDS; do
              ASSOC_IDS=$(aws ec2 describe-route-tables --route-table-ids "$RT" --query "RouteTables[].Associations[].RouteTableAssociationId" --output text)
              for ASSOC in $ASSOC_IDS; do
                if [ "$ASSOC" != "None" ] && [ -n "$ASSOC" ]; then
                  aws ec2 delete-route-table-association --association-id "$ASSOC" || true
                fi
              done
            done

            # Delete route tables
            for RT in $RT_IDS; do
              if [ "$RT" != "None" ] && [ -n "$RT" ]; then
                aws ec2 delete-route-table --route-table-id "$RT" || true
              fi
            done

            # Delete security groups by Name tag
            for SG_NAME in tech-challenge-app-sg tech-challenge-db-sg; do
              SG_ID=$(aws ec2 describe-security-groups --filters "Name=vpc-id,Values=$VPC_ID" "Name=group-name,Values=$SG_NAME" --query "SecurityGroups[0].GroupId" --output text)
              if [ "$SG_ID" != "None" ] && [ -n "$SG_ID" ]; then
                aws ec2 delete-security-group --group-id "$SG_ID" || true
              fi
            done

            # Delete subnets by Name tag values
            for SUB_NAME in tech-challenge-public-subnet tech-challenge-private-subnet-a tech-challenge-private-subnet-b; do
              SUB_ID=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=$VPC_ID" "Name=tag:Name,Values=$SUB_NAME" --query "Subnets[0].SubnetId" --output text)
              if [ "$SUB_ID" != "None" ] && [ -n "$SUB_ID" ]; then
                aws ec2 delete-subnet --subnet-id "$SUB_ID" || true
              fi
            done

            aws ec2 delete-vpc --vpc-id "$VPC_ID" || true
          fi
